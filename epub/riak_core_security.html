<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Riak Core Security</title>
    
    <link rel="stylesheet" href="_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" /> 
  </head>
  <body>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="riak_core_metadata.html" title="Riak Core Metadata"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Little Riak Core Book 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="riak-core-security">
<h1>Riak Core Security</h1>
<p>riak_core_security is a module in riak_core that provides facilities to
implement user/group management, authentication and authorization.</p>
<p>Here we will see an overview of it.</p>
<div class="section" id="implementation">
<h2>Implementation</h2>
<p>riak_core_security is implemented on top of riak_core_metadata, it uses the
following keys to store its information:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;security&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;users&quot;</span><span class="o">&gt;&gt;</span><span class="p">}</span>
<span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;security&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;groups&quot;</span><span class="o">&gt;&gt;</span><span class="p">}</span>
<span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;security&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;sources&quot;</span><span class="o">&gt;&gt;</span><span class="p">}</span>
<span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;security&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;usergrants&quot;</span><span class="o">&gt;&gt;</span><span class="p">}</span>
<span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;security&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;groupgrants&quot;</span><span class="o">&gt;&gt;</span><span class="p">}</span>
<span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;security&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;status&quot;</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">enabled</span>
<span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;security&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;config&quot;</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">ciphers</span>
</pre></div>
</div>
<p>How they are stored should be an implementation detail but sometimes you may
need to fold over values to get information if it&#8217;s not supported by
riak_core_security&#8217;s API.</p>
</div>
<div class="section" id="vocabulary">
<h2>Vocabulary</h2>
<div class="section" id="context">
<h3>Context</h3>
<p>Opaque information you get back from authentication, you have to pass it back
in to other operations.</p>
<p>At the moment it&#8217;s a record with three fields:</p>
<ul class="simple">
<li>username</li>
<li>grants</li>
<li>epoch</li>
</ul>
<p>But notice that this is an implementation detail and you should handle it
as an opaque value.</p>
<p>Contexts are only valid until the GRANT epoch changes, and it will change
whenever a GRANT or a REVOKE is performed. This rule may change in the future.</p>
</div>
<div class="section" id="permission">
<h3>Permission</h3>
<p>A string that represents some action in a given application, for example
tanodb.get, tanodb.put.</p>
<p>A permission muy be listed as valid in the environment variable {riak_core, permissions}:</p>
<div class="highlight-python"><div class="highlight"><pre>(tanodb@127.0.0.1)1&gt; application:get_env(riak_core, permissions).
{ok,[{riak_core,[get_bucket,set_bucket,get_bucket_type, set_bucket_type]}]}
</pre></div>
</div>
<p>You can list your permissions in config/advanced.config uncommenting the line:</p>
<div class="highlight-python"><div class="highlight"><pre>% {permissions, [{ tanodb, [put, get, list, grant, delete]}]}
</pre></div>
</div>
<p>And changing the permissions inside the list.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">tanodb is the name of your app</p>
</div>
</div>
<div class="section" id="role">
<h3>Role</h3>
<p>Something you assign permissions to, it can be a user or a group, there are
some reserved roles:</p>
<ul class="simple">
<li>all</li>
<li>on</li>
<li>to</li>
<li>from</li>
<li>any</li>
</ul>
</div>
<div class="section" id="source">
<h3>Source</h3>
<p>The source where the user is authenticating, it can be an ip or something else,
you can allow a user to authenticate from a source but not another.</p>
</div>
</div>
<div class="section" id="extra-features">
<h2>Extra Features</h2>
<ul class="simple">
<li>Certificate Authentication</li>
<li>Plugable Authentication</li>
</ul>
</div>
<div class="section" id="api-overview">
<h2>API Overview</h2>
<div class="section" id="check-permission">
<h3>check_permission</h3>
<div class="highlight-erlang"><div class="highlight"><pre><span class="c">% Check a Global permission, one that is not tied to a bucket</span>
<span class="nf">check_permission</span><span class="p">({</span><span class="nv">Permission</span><span class="p">},</span> <span class="nv">Context</span><span class="p">)</span>

<span class="c">% Check a permission for a specific bucket</span>
<span class="nf">check_permission</span><span class="p">({</span><span class="nv">Permission</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">},</span> <span class="nv">Context</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="check-permissions">
<h3>check_permissions</h3>
<div class="highlight-erlang"><div class="highlight"><pre><span class="c">% Check that all permissions are valid</span>
<span class="nf">check_permissions</span><span class="p">(</span><span class="nv">List</span><span class="p">,</span> <span class="nv">Ctx</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="get-username">
<h3>get_username</h3>
<div class="highlight-erlang"><div class="highlight"><pre><span class="c">% return username from context</span>
<span class="nf">get_username</span><span class="p">(</span><span class="nv">Context</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="authenticate">
<h3>authenticate</h3>
<p>If successful it will return {ok, Context}</p>
<p>A username can be tied to specific sources from which he can login, if you
don&#8217;t need this feature specify a generic source for all your users.</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">authenticate</span><span class="p">(</span><span class="nv">Username</span><span class="p">,</span> <span class="nv">Password</span><span class="p">,</span> <span class="nv">ConnInfo</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="add-user">
<h3>add_user</h3>
<p>Valid options:</p>
<ul class="simple">
<li>password</li>
<li>groups</li>
</ul>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">add_user</span><span class="p">(</span><span class="nv">Username</span><span class="p">,</span> <span class="nv">Options</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="add-group">
<h3>add_group</h3>
<p>Valid options:</p>
<ul class="simple">
<li>password</li>
</ul>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">add_group</span><span class="p">(</span><span class="nv">Groupname</span><span class="p">,</span> <span class="nv">Options</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="alter-user">
<h3>alter_user</h3>
<p>Options passed will override options already in user&#8217;s details, this means if
you pass a password it will be changed, if you pass groups the new groups will
be set and the old removed.</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">alter_user</span><span class="p">(</span><span class="nv">Username</span><span class="p">,</span> <span class="nv">Options</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="alter-group">
<h3>alter_group</h3>
<p>Options passed will override options already in groups&#8217;s details, if you pass
groups the new groups will be set and the old removed.</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">alter_group</span><span class="p">(</span><span class="nv">Groupname</span><span class="p">,</span> <span class="nv">Options</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="del-user">
<h3>del_user</h3>
<p>Deletes user and associated grants</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">del_user</span><span class="p">(</span><span class="nv">Username</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="del-group">
<h3>del_group</h3>
<p>Deletes group and associated grants</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">del_group</span><span class="p">(</span><span class="nv">Groupname</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="add-grant">
<h3>add_grant</h3>
<p>Add Grants to RoleList on Bucket, RoleList can be the atom <strong>all</strong> to asign
Grants to all roles in that Bucket.</p>
<p>Bucket can be a binary to assign to the whole bucket or {binary(), binary()},
to assign to a key in the bucket.</p>
<p>The call will merge previous grants with the new ones.</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">add_grant</span><span class="p">(</span><span class="nv">RoleList</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">,</span> <span class="nv">Grants</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="add-revoke">
<h3>add_revoke</h3>
<p>Revoke Grants to RoleList on Bucket, RoleList can be the atom <strong>all</strong> to revoke
Grants to all roles in that Bucket.</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">add_revoke</span><span class="p">(</span><span class="nv">RoleList</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">,</span> <span class="nv">Revokes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="add-source">
<h3>add_source</h3>
<p>Users is a list of users or the atom <strong>all</strong> to apply to all users.
CIDR is a tuple with an IP address and a mask in bits.
Source is an atom:</p>
<ul class="simple">
<li>trust: no password required</li>
<li>password: password authentication</li>
<li>certificate: certificate authentication</li>
<li>Atom: Atom will be used as a custom authentication module, on auth Atom will
be looked up on the env key {riak_core, auth_mods} if found the returned
value will be used as a module to call
AuthMod:auth(Username, Password, UserData, SourceOptions)</li>
</ul>
<p>Options are options for the source that will be passed during auth</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">add_source</span><span class="p">(</span><span class="nv">Users</span><span class="p">,</span> <span class="nv">CIDR</span><span class="p">,</span> <span class="nv">Source</span><span class="p">,</span> <span class="nv">Options</span><span class="p">)</span>
</pre></div>
</div>
<p>Example calls:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">add_source</span><span class="p">(</span><span class="n">all</span><span class="p">,</span> <span class="p">{{</span><span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="mi">32</span><span class="p">},</span> <span class="n">trust</span><span class="p">,</span> <span class="p">[])</span>
<span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">add_source</span><span class="p">(</span><span class="n">all</span><span class="p">,</span> <span class="p">{{</span><span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="mi">32</span><span class="p">},</span> <span class="n">password</span><span class="p">,</span> <span class="p">[])</span>
</pre></div>
</div>
</div>
<div class="section" id="del-source">
<h3>del_source</h3>
<p>Delete source identified by CIDR for Users, Users can be the atom <strong>all</strong> to
remove the source from all users. This won&#8217;t apply to sources added for each
users, only if the source was added explicitly for the <strong>all</strong> atom.</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">del_source</span><span class="p">(</span><span class="nv">Users</span><span class="p">,</span> <span class="nv">CIDR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="is-enabled">
<h3>is_enabled</h3>
<p>Returns <strong>true</strong> if riak_core_security is enabled, <strong>false</strong> otherwise.</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">is_enabled</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="enable">
<h3>enable</h3>
<p>Enables riak_core_security</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">enable</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="disable">
<h3>disable</h3>
<p>Disabled riak_core_security</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">disable</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="status">
<h3>status</h3>
<p>Returns an atom representing the  status of riak_core_security:</p>
<ul class="simple">
<li>enabled</li>
<li>enabled_but_no_capability</li>
<li>disabled</li>
</ul>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nf">status</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="playing-in-the-repl">
<h2>Playing in the REPL</h2>
<p>First we will need to uncomment the permissions for our app in config/advanced.config</p>
<p>TODO: commit hash here</p>
<p>Then we build again and run it:</p>
<div class="highlight-shell"><div class="highlight"><pre>rebar3 release
rebar3 run
</pre></div>
</div>
<p>First let&#8217;s setup some variables</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">1</span><span class="o">&gt;</span> <span class="nv">User1</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">.</span>
<span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">2</span><span class="o">&gt;</span> <span class="nv">Pass1</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="s">&quot;secret&quot;</span><span class="o">&gt;&gt;</span><span class="p">.</span>
<span class="o">&lt;&lt;</span><span class="s">&quot;secret&quot;</span><span class="o">&gt;&gt;</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">3</span><span class="o">&gt;</span> <span class="nv">ConnInfo</span> <span class="o">=</span> <span class="p">[{</span><span class="n">ip</span><span class="p">,</span> <span class="p">{</span><span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}}].</span>
<span class="p">[{</span><span class="n">ip</span><span class="p">,{</span><span class="mi">127</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">}}]</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">4</span><span class="o">&gt;</span> <span class="nv">Source1</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="mi">32</span><span class="p">}.</span>
<span class="p">{{</span><span class="mi">127</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span><span class="mi">32</span><span class="p">}</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">5</span><span class="o">&gt;</span> <span class="nv">Bucket1</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="s">&quot;bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">.</span>
<span class="o">&lt;&lt;</span><span class="s">&quot;bucket_sandy&quot;</span><span class="o">&gt;&gt;</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">6</span><span class="o">&gt;</span> <span class="nv">PermGet</span> <span class="o">=</span> <span class="s">&quot;tanodb.get&quot;</span><span class="p">.</span>
<span class="s">&quot;tanodb.get&quot;</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">7</span><span class="o">&gt;</span> <span class="nv">PermPut</span> <span class="o">=</span> <span class="s">&quot;tanodb.put&quot;</span><span class="p">.</span>
<span class="s">&quot;tanodb.put&quot;</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">8</span><span class="o">&gt;</span> <span class="nv">PermList</span> <span class="o">=</span> <span class="s">&quot;tanodb.list&quot;</span><span class="p">.</span>
<span class="s">&quot;tanodb.list&quot;</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">9</span><span class="o">&gt;</span> <span class="nv">GroupWriter</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="s">&quot;writers&quot;</span><span class="o">&gt;&gt;</span><span class="p">.</span>
<span class="o">&lt;&lt;</span><span class="s">&quot;writers&quot;</span><span class="o">&gt;&gt;</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">10</span><span class="o">&gt;</span> <span class="nv">GroupReader</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="s">&quot;readers&quot;</span><span class="o">&gt;&gt;</span><span class="p">.</span>
<span class="o">&lt;&lt;</span><span class="s">&quot;readers&quot;</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
<p>We didn&#8217;t add the user yet, so the following should fail</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">11</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">authenticate</span><span class="p">(</span><span class="nv">User1</span><span class="p">,</span> <span class="nv">Pass1</span><span class="p">,</span> <span class="nv">ConnInfo</span><span class="p">).</span>
<span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="n">unknown_user</span><span class="p">}</span>
</pre></div>
</div>
<p>Let&#8217;s add the user</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">12</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">add_user</span><span class="p">(</span><span class="nv">User1</span><span class="p">,</span> <span class="p">[{</span><span class="s">&quot;password&quot;</span><span class="p">,</span> <span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Pass1</span><span class="p">)}]).</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>Adding it twice should fail</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">13</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">add_user</span><span class="p">(</span><span class="nv">User1</span><span class="p">,</span> <span class="p">[{</span><span class="s">&quot;password&quot;</span><span class="p">,</span> <span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Pass1</span><span class="p">)}]).</span>
<span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="n">role_exists</span><span class="p">}</span>
</pre></div>
</div>
<p>We didn&#8217;t add the source for the user so the following should fail</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">14</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">authenticate</span><span class="p">(</span><span class="nv">User1</span><span class="p">,</span> <span class="nv">Pass1</span><span class="p">,</span> <span class="nv">ConnInfo</span><span class="p">).</span>
<span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="n">no_matching_sources</span><span class="p">}</span>
</pre></div>
</div>
<p>Add a local source that requires password for all users</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">15</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">add_source</span><span class="p">(</span><span class="n">all</span><span class="p">,</span> <span class="nv">Source1</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="p">[]).</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>Now it should work</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">16</span><span class="o">&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Ctx1</span><span class="p">}</span> <span class="o">=</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">authenticate</span><span class="p">(</span><span class="nv">User1</span><span class="p">,</span> <span class="nv">Pass1</span><span class="p">,</span> <span class="nv">ConnInfo</span><span class="p">).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,{</span><span class="n">context</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,[],{</span><span class="mi">1444</span><span class="p">,</span><span class="mi">659568</span><span class="p">,</span><span class="mi">765253</span><span class="p">}}}</span>
</pre></div>
</div>
<p>Checking permissions should fail, since we didn&#8217;t granted any permissions yet</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">17</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">check_permission</span><span class="p">({</span><span class="nv">PermGet</span><span class="p">,</span> <span class="nv">Bucket1</span><span class="p">},</span> <span class="nv">Ctx1</span><span class="p">).</span>
<span class="p">{</span><span class="n">false</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;Permission denied: User &#39;sandy&#39; does not have &#39;tanodb.get&#39; on bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
   <span class="p">{</span><span class="n">context</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,[],{</span><span class="mi">1444</span><span class="p">,</span><span class="mi">659568</span><span class="p">,</span><span class="mi">765253</span><span class="p">}}}</span>
</pre></div>
</div>
<p>Let&#8217;s grant PermGet to User1</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">18</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">add_grant</span><span class="p">([</span><span class="nv">User1</span><span class="p">],</span> <span class="nv">Bucket1</span><span class="p">,</span> <span class="p">[</span><span class="nv">PermGet</span><span class="p">]).</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>And try again</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">19</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">check_permission</span><span class="p">({</span><span class="nv">PermGet</span><span class="p">,</span> <span class="nv">Bucket1</span><span class="p">},</span> <span class="nv">Ctx1</span><span class="p">).</span>
<span class="p">{</span><span class="n">true</span><span class="p">,{</span><span class="n">context</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
           <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,[</span><span class="s">&quot;tanodb.get&quot;</span><span class="p">]}],</span>
           <span class="p">{</span><span class="mi">1444</span><span class="p">,</span><span class="mi">659568</span><span class="p">,</span><span class="mi">779759</span><span class="p">}}}</span>
</pre></div>
</div>
<p>cReate some groups, each group belongs to the previous one</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">20</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">add_group</span><span class="p">(</span><span class="nv">GroupReader</span><span class="p">,</span> <span class="p">[]).</span>
<span class="nf">ok</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">21</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">add_group</span><span class="p">(</span><span class="nv">GroupWriter</span><span class="p">,</span> <span class="p">[{</span><span class="s">&quot;groups&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">GroupReader</span><span class="p">]}]).</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>Let&#8217;s grant permissions to each group</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">22</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">add_grant</span><span class="p">([</span><span class="nv">GroupReader</span><span class="p">],</span> <span class="nv">Bucket1</span><span class="p">,</span> <span class="p">[</span><span class="nv">PermGet</span><span class="p">]).</span>
<span class="nf">ok</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">23</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">add_grant</span><span class="p">([</span><span class="nv">GroupWriter</span><span class="p">],</span> <span class="nv">Bucket1</span><span class="p">,</span> <span class="p">[</span><span class="nv">PermPut</span><span class="p">]).</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>Now let&#8217;s join User1 to some groups and try permissions</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">24</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">alter_user</span><span class="p">(</span><span class="nv">User1</span><span class="p">,</span> <span class="p">[{</span><span class="s">&quot;groups&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">GroupReader</span><span class="p">]}]).</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>We can see User1 is a member of the group</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">25</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">print_user</span><span class="p">(</span><span class="nv">User1</span><span class="p">).</span>
<span class="n">ok</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>+----------+---------------+----------------------------------------+------------------------------+

| username |   member of   |                password                |           options            |
+----------+---------------+----------------------------------------+------------------------------+
|  sandy   |    readers    |9c8984b176e07eb7ba9ff1e3ada5a43ecb8a812e|              []              |
+----------+---------------+----------------------------------------+------------------------------+
</pre></div>
</div>
<p>She can do PermGet on Bucket1, but she could before since she has the
permission explicitly set</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">26</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">check_permission</span><span class="p">({</span><span class="nv">PermGet</span><span class="p">,</span> <span class="nv">Bucket1</span><span class="p">},</span> <span class="nv">Ctx1</span><span class="p">).</span>
<span class="p">{</span><span class="n">true</span><span class="p">,{</span><span class="n">context</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
           <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,[</span><span class="s">&quot;tanodb.get&quot;</span><span class="p">]}],</span>
           <span class="p">{</span><span class="mi">1444</span><span class="p">,</span><span class="mi">659568</span><span class="p">,</span><span class="mi">837358</span><span class="p">}}}</span>
</pre></div>
</div>
<p>Let&#8217;s revoke it</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">27</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">add_revoke</span><span class="p">([</span><span class="nv">User1</span><span class="p">],</span> <span class="nv">Bucket1</span><span class="p">,</span> <span class="p">[</span><span class="nv">PermGet</span><span class="p">]).</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>Still can</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">28</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">check_permission</span><span class="p">({</span><span class="nv">PermGet</span><span class="p">,</span> <span class="nv">Bucket1</span><span class="p">},</span> <span class="nv">Ctx1</span><span class="p">).</span>
<span class="p">{</span><span class="n">true</span><span class="p">,{</span><span class="n">context</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
           <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,[</span><span class="s">&quot;tanodb.get&quot;</span><span class="p">]}],</span>
           <span class="p">{</span><span class="mi">1444</span><span class="p">,</span><span class="mi">659568</span><span class="p">,</span><span class="mi">847161</span><span class="p">}}}</span>
</pre></div>
</div>
<p>But can&#8217;t put on that bucket</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">29</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">check_permission</span><span class="p">({</span><span class="nv">PermPut</span><span class="p">,</span> <span class="nv">Bucket1</span><span class="p">},</span> <span class="nv">Ctx1</span><span class="p">).</span>
<span class="p">{</span><span class="n">false</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;Permission denied: User &#39;sandy&#39; does not have &#39;tanodb.put&#39; on bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
   <span class="p">{</span><span class="n">context</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
            <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,[</span><span class="s">&quot;tanodb.get&quot;</span><span class="p">]}],</span>
            <span class="p">{</span><span class="mi">1444</span><span class="p">,</span><span class="mi">659568</span><span class="p">,</span><span class="mi">848204</span><span class="p">}}}</span>
</pre></div>
</div>
<p>Now let&#8217;s join User1 to some groups and try permissions</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">30</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">alter_user</span><span class="p">(</span><span class="nv">User1</span><span class="p">,</span> <span class="p">[{</span><span class="s">&quot;groups&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">GroupWriter</span><span class="p">]}]).</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>We can see User1 is a member of the group, but no more of GroupReader</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">31</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">print_user</span><span class="p">(</span><span class="nv">User1</span><span class="p">).</span>
<span class="n">ok</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>+----------+---------------+----------------------------------------+------------------------------+
| username |   member of   |                password                |           options            |
+----------+---------------+----------------------------------------+------------------------------+
|  sandy   |    writers    |9c8984b176e07eb7ba9ff1e3ada5a43ecb8a812e|              []              |
+----------+---------------+----------------------------------------+------------------------------+
</pre></div>
</div>
<p>User1 can now put on that bucket</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">32</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">check_permission</span><span class="p">({</span><span class="nv">PermPut</span><span class="p">,</span> <span class="nv">Bucket1</span><span class="p">},</span> <span class="nv">Ctx1</span><span class="p">).</span>
<span class="p">{</span><span class="n">true</span><span class="p">,{</span><span class="n">context</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
           <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,[</span><span class="s">&quot;tanodb.get&quot;</span><span class="p">,</span><span class="s">&quot;tanodb.put&quot;</span><span class="p">]}],</span>
           <span class="p">{</span><span class="mi">1444</span><span class="p">,</span><span class="mi">659568</span><span class="p">,</span><span class="mi">859448</span><span class="p">}}}</span>
</pre></div>
</div>
<p>Still can get since GroupWriter is member of the group GroupReader</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">33</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">check_permission</span><span class="p">({</span><span class="nv">PermGet</span><span class="p">,</span> <span class="nv">Bucket1</span><span class="p">},</span> <span class="nv">Ctx1</span><span class="p">).</span>
<span class="p">{</span><span class="n">true</span><span class="p">,{</span><span class="n">context</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
           <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,[</span><span class="s">&quot;tanodb.get&quot;</span><span class="p">,</span><span class="s">&quot;tanodb.put&quot;</span><span class="p">]}],</span>
           <span class="p">{</span><span class="mi">1444</span><span class="p">,</span><span class="mi">659568</span><span class="p">,</span><span class="mi">860961</span><span class="p">}}}</span>
</pre></div>
</div>
<p>Now let&#8217;s add a new grant to GroupReader so they can list the bucket</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">34</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">add_grant</span><span class="p">([</span><span class="nv">GroupReader</span><span class="p">],</span> <span class="nv">Bucket1</span><span class="p">,</span> <span class="p">[</span><span class="nv">PermList</span><span class="p">]).</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>Now User1 has the list permission since she is a member of GroupWriter
which is a member of GroupReader who has permissions to list Bucket1</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">35</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">check_permission</span><span class="p">({</span><span class="nv">PermList</span><span class="p">,</span> <span class="nv">Bucket1</span><span class="p">},</span> <span class="nv">Ctx1</span><span class="p">).</span>
<span class="p">{</span><span class="n">true</span><span class="p">,{</span><span class="n">context</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
           <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
             <span class="p">[</span><span class="s">&quot;tanodb.get&quot;</span><span class="p">,</span><span class="s">&quot;tanodb.list&quot;</span><span class="p">,</span><span class="s">&quot;tanodb.put&quot;</span><span class="p">]}],</span>
           <span class="p">{</span><span class="mi">1444</span><span class="p">,</span><span class="mi">659568</span><span class="p">,</span><span class="mi">872565</span><span class="p">}}}</span>
</pre></div>
</div>
<p>Let&#8217;s remove GroupReader membership from GroupWriter</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">36</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">alter_group</span><span class="p">(</span><span class="nv">GroupWriter</span><span class="p">,</span> <span class="p">[{</span><span class="s">&quot;groups&quot;</span><span class="p">,</span> <span class="p">[]}]).</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>Now User1 can&#8217;t list on Bucket1 anymore</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">37</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">check_permission</span><span class="p">({</span><span class="nv">PermList</span><span class="p">,</span> <span class="nv">Bucket1</span><span class="p">},</span> <span class="nv">Ctx1</span><span class="p">).</span>
<span class="p">{</span><span class="n">false</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;Permission denied: User &#39;sandy&#39; does not have &#39;tanodb.list&#39; on bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
   <span class="p">{</span><span class="n">context</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
            <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,[</span><span class="s">&quot;tanodb.put&quot;</span><span class="p">]}],</span>
            <span class="p">{</span><span class="mi">1444</span><span class="p">,</span><span class="mi">659568</span><span class="p">,</span><span class="mi">881585</span><span class="p">}}}</span>
</pre></div>
</div>
<p>Let&#8217;s try one more thing, add GroupWriter to GroupReader</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">38</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">alter_group</span><span class="p">(</span><span class="nv">GroupWriter</span><span class="p">,</span> <span class="p">[{</span><span class="s">&quot;groups&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">GroupReader</span><span class="p">]}]).</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>This works again</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">39</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">check_permission</span><span class="p">({</span><span class="nv">PermList</span><span class="p">,</span> <span class="nv">Bucket1</span><span class="p">},</span> <span class="nv">Ctx1</span><span class="p">).</span>
<span class="p">{</span><span class="n">true</span><span class="p">,{</span><span class="n">context</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
           <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
             <span class="p">[</span><span class="s">&quot;tanodb.get&quot;</span><span class="p">,</span><span class="s">&quot;tanodb.list&quot;</span><span class="p">,</span><span class="s">&quot;tanodb.put&quot;</span><span class="p">]}],</span>
           <span class="p">{</span><span class="mi">1444</span><span class="p">,</span><span class="mi">659568</span><span class="p">,</span><span class="mi">890698</span><span class="p">}}}</span>
</pre></div>
</div>
<p>Let&#8217;s now remove GroupReader completely</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">40</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">del_group</span><span class="p">(</span><span class="nv">GroupReader</span><span class="p">).</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>This should fail again</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">41</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">check_permission</span><span class="p">({</span><span class="nv">PermList</span><span class="p">,</span> <span class="nv">Bucket1</span><span class="p">},</span> <span class="nv">Ctx1</span><span class="p">).</span>
<span class="p">{</span><span class="n">false</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;Permission denied: User &#39;sandy&#39; does not have &#39;tanodb.list&#39; on bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
   <span class="p">{</span><span class="n">context</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
            <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket_sandy&quot;</span><span class="o">&gt;&gt;</span><span class="p">,[</span><span class="s">&quot;tanodb.put&quot;</span><span class="p">]}],</span>
            <span class="p">{</span><span class="mi">1444</span><span class="p">,</span><span class="mi">659568</span><span class="p">,</span><span class="mi">914573</span><span class="p">}}}</span>
</pre></div>
</div>
<p>Let&#8217;s clean everything up</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">42</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">del_group</span><span class="p">(</span><span class="nv">GroupWriter</span><span class="p">).</span>
<span class="nf">ok</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">43</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">del_user</span><span class="p">(</span><span class="nv">User1</span><span class="p">).</span>
<span class="nf">ok</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">44</span><span class="o">&gt;</span> <span class="nn">riak_core_security</span><span class="p">:</span><span class="nf">del_source</span><span class="p">(</span><span class="n">all</span><span class="p">,</span> <span class="nv">Source1</span><span class="p">).</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>If you want to retry from scratch removing all state you can do the following:</p>
<div class="highlight-python"><div class="highlight"><pre>rm -rf _build/default/rel
rebar3 release
rebar3 run
</pre></div>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer">
        &copy; Copyright 2015, Mariano Guerra.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>